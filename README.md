# getappmap/analyze-action

> To get started with AppMap in GitHub actions, you need to start by installing the [AppMap App on the official GitHub Marketplace](https://github.com/marketplace/get-appmap)
>
> To see a step-by-step example of how to install this action into your software project, [review the official AppMap Documentation](http://appmap.io/docs/analysis/in-github-actions).

`getappmap/analyze-action` is a GitHub Action to perform runtime code review of the changes between any two versions of a project.

Runtime code review is performed by comparing two AppMap archives - "base" and "head". The "base" archive is created by the  
[`getappmap/archive-action`](https://github.com/getappmap/archive-action/blob/main/action.yml) Action when code is merged to main.
The "head" archive is created by this Action as part of its operation. 

The report generated by this Action includes root cause analysis of failed tests, a list of API changes, new and resolved analysis findings (anti-patterns and flaws), 
and lists of new and changed AppMaps. This action also adds code annotations which identify the root cause of failed tests and analysis findings.

## Table of contents

- [Requirements](#requirements)
- [Inputs](#inputs)
- [Outputs](#outputs)
- [Examples](#examples)
- [Development](#development)

## Requirements

This action requires an [`archive-action`](https://github.com/getappmap/archive-action/) to have successfully completed on the base SHA that is used for comparison.

## Inputs

Add a step like this to your workflow:

```yaml
- name: Archive AppMaps
  uses: getappmap/analyze-action@v1
    # Command working directory. Use this option this to install AppMap to a 
    # subdirectory of a monorepo / multi-folder project. When this input is specified,
    # AppMaps that project will be written to the directory `$directory/tmp/appmap`.
    # Be aware of this in any subsequent steps.
    # Default: '.'
    directory: ./projects/backend
    
    # The base revision to compare against. The default is the GITHUB_BASE_REF, which
    # is the name of the base ref or target branch of the pull request in a workflow run.
    base-revision: ${{ github.event.pull_request.base.sha }}
    
    # The head revision to compare against. The default is the GITHUB_SHA, which
    # according to GitHub is the commit that triggered the workflow run.
    head-revision: ${{ github.event.pull_request.head.sha }}

    # The GitHub token to use with the GitHub API to enumerate AppMap Tools 
    # releases.
    # Default: `${{ github.token }}`
    github-token: secrets.CUSTOM_GITHUB_TOKEN

    # The number of days of history to fetch in order to find the most recent ancestor that has
    # an AppMap archive. If an archive is not found, within this time window,
    # the entire history will be fetched. To disable history fetching completely, set this value to 0.
    # Default: 30
    fetch-history-days: 90

    # Number of days that the archive artifacts are retained for. Note that the AppMap archives created
    # by analyze-action are always built from the AppMaps on a PR branch, and therefore they are 
    # inherently more ephemeral than the base branch AppMaps created the archive-action. Therefore
    # a fairly short retention period is recommended. If artifacts need to be re-generated for
    # some reason, the workflow job can be re-run.
    # Default: 7
    archive-retention-days: 14
      
    # Number of worker threads to use for processing the archive. Defaults to the 
    # number of CPUs / cores, as reported by Node.js. If the worker machine has 
    # a high number of CPUs/cores, the archive action may become I/O-bound rather 
    # than CPU-bound, and better performance might be obtained by setting this 
    # value to a lower number.
    thread-count: 4
    
    # Directories to ignore when generating annotations. Please enter the exclusions as a 
    # space-separated list (e.g. build tmp dist).
    # Default: 'node_modules vendor'
    annotation-exclusions: 'virtualenv node_modules'

    # Sections to include in the report. Enter the sections as a space-separated list. 
    # The default is to generate all sections except for those which are in beta / early access. 
    # Contact [AppMap Support](mailto:support@appmap.io) to be included in any beta / early access 
    # report features.
    include-sections: 'lorem ipsum'

    # Sections to exclude from the report. Enter the sections as a space-separated list. 
    # The default is to generate all sections except for those which are in beta / early access.
    exclude-sections: 'test-failures api'

    # Enable verbose logging of CLI subcommands. You can use the standard GitHub
    # Action log level option to control verbosity of this Action itself.
    # Default: false
    verbose: true
```

## Outputs

The action provides these outputs:

- `report-dir`: Directory containing the report files.

## Examples

To analyze the BASE and HEAD of a branch in a Pull Request and compare the difference in the runtime of the code.

```yaml
- name: Analyze AppMaps
  uses: getappmap/analyze-action@v1
  if: github.event_name == 'pull_request'
  with:
    directory: ${{ inputs.directory }}
    base-revision: ${{ github.event.pull_request.base.sha }}
    head-revision: ${{ github.event.pull_request.head.sha }}
```

## Development

```
# Remove build artifacts
$ yarn clean

# Build the project
$ yarn build

# Run tests
$ yarn test

# Package the project into a distributable GitHub action
$ yarn package
```
